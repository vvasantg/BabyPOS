using System.Net.Http;
using System.Net.Http.Json;
using System.Threading.Tasks;
using BabyPOS_Web.Models;

namespace BabyPOS_Web.ViewModels
{
    public class LoginViewModel
    {
        private readonly HttpClient _http;
        public string Username { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
        public string ErrorMessage { get; set; } = string.Empty;
        public string? Token { get; set; }
        public User? CurrentUser { get; set; }

        public LoginViewModel(HttpClient http)
        {
            _http = http;
        }

        public async Task<bool> LoginAsync()
        {
            var loginUser = new User { Username = Username, Password = Password };
            var response = await _http.PostAsJsonAsync("/api/users/login", loginUser);
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<LoginResult>();
                Token = result?.token;
                CurrentUser = result == null ? null : new User {
                    Id = result.user.Id,
                    Username = result.user.Username,
                    Email = result.user.Email
                };
                ErrorMessage = string.Empty;
                return true;
            }
            ErrorMessage = "Login failed. Please try again.";
            return false;
        }

        public class LoginResult
        {
            public string token { get; set; } = string.Empty;
            public User user { get; set; } = new User();
        }
    }
}
