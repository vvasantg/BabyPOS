@page "/login"
@using BabyPOS_Web.ViewModels
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IJSRuntime JS

@code {
    private LoginViewModel vm;
    protected override void OnInitialized()
    {
        vm = new LoginViewModel(Http);
    }
}

<h3>Login</h3>
<div>
    <label>Username</label>
    <InputText @bind-Value="vm.Username" @oninput="OnUsernameInput" />
</div>
<div>
    <label>Password</label>
    <InputText @bind-Value="vm.Password" type="password" @oninput="OnPasswordInput" />
</div>
<button @onclick="OnLogin">Login</button>

<div style="margin-top:12px">
    <NavLink href="/register">Register</NavLink>
</div>

@if (!string.IsNullOrEmpty(vm.ErrorMessage))
{
    <div style="color:red">@vm.ErrorMessage</div>
}

@code {
    private void OnUsernameInput(ChangeEventArgs e)
    {
        var input = e.Value?.ToString() ?? string.Empty;
        var filtered = System.Text.RegularExpressions.Regex.Replace(input, "[^a-zA-Z0-9]", "");
        if (filtered != vm.Username)
        {
            vm.Username = filtered;
        }
    }
    private void OnPasswordInput(ChangeEventArgs e)
    {
        var input = e.Value?.ToString() ?? string.Empty;
        var filtered = System.Text.RegularExpressions.Regex.Replace(input, "[^a-zA-Z0-9]", "");
        if (filtered != vm.Password)
        {
            vm.Password = filtered;
        }
    }
    private async Task OnLogin()
    {
        var success = await vm.LoginAsync();
        if (success && !string.IsNullOrEmpty(vm.Token))
        {
            // Save token to localStorage
            await JS.InvokeVoidAsync("localStorage.setItem", "jwt", vm.Token);
            // Force reload to update ShopList state
            Navigation.NavigateTo("/", true);
        }
    }
}
